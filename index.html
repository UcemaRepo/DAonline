<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adhesión Débito Automático | UCEMA</title>

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="stylesheet" href="styles.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
<div class="progress-wrapper">
  <div class="progress-bar" id="progressBar"></div>
</div>

<header class="header">
  <div class="header-inner">
    <img src="logo.svg" alt="Universidad del CEMA" class="logo">
    <div class="header-text">
      <h1>Adhesión Débito Automático</h1>
      <p>Universidad del CEMA</p>
    </div>
  </div>
</header>

  
<div class="container">
<h2>Adhesión Débito Automático</h2>

<label>Ubicación dónde se está firmando el documento (Ejemplo: Reconquista 775, CABA)</label>
<input type="text" id="lugar" maxlength="50">

<label>Fecha</label>
<input type="date" id="fecha">

<hr>

<label>Tipo de Persona</label>
<select id="tipo_persona" onchange="actualizarPersona()">
  <option value="">Seleccione...</option>
  <option value="fisica">Persona Física</option>
  <option value="juridica">Persona Jurídica</option>
</select>

<div id="fisica_section" class="fade-section">
  <label>Nombre Persona Física</label>
  <input type="text" id="pers_fis_nombre" maxlength="50">
</div>

<div id="juridica_section" class="fade-section">
  <label>Nombre Persona Jurídica</label>
  <input type="text" id="pers_ju_nombre" maxlength="50">

  <label>CUIT</label>
  <input type="text" inputmode="numeric" id="cuit" maxlength="11">
</div>


<hr>

<h3>Tarjeta</h3>

<select id="tipo_tarjeta" onchange="actualizarTarjeta()">
  <option value="">Seleccione tarjeta...</option>
  <option value="Visa">Visa</option>
  <option value="Master">Mastercard</option>
  <option value="American">American Express</option>
</select>

<div id="tarjeta_section" class="fade-section">
  <label>Número de Tarjeta</label>
  <input type="text" inputmode="numeric" id="numero_tarjeta" maxlength="16" pattern="\d{16}">
</div>


<hr>

<h3>Datos del Alumno</h3>

<label>Firma Alumno</label>
<canvas id="firma_alumno"></canvas>
<br>
<button type="button" onclick="signatureAlumno.clear()">Borrar firma alumno</button>

<hr>

<label>Aclaración Alumno</label>
<input type="text" id="aclaracion_alum" maxlength="50">

<label>Documento Alumno</label>
<input type="text" inputmode="numeric" id="documento_alum" maxlength="20"  pattern="\d{1,20}">

<hr>

<h3>Datos del Titular</h3>

<label>Firma Titular</label>
<canvas id="firma_titular"></canvas>
<br>
<button type="button" onclick="signatureTitular.clear()">Borrar firma titular</button>

<label>Aclaración Titular</label>
<input type="text" id="aclaracion_tit" maxlength="50">

<label>Documento Titular</label>
<input type="text" inputmode="numeric" id="documento_tit" maxlength="20"  pattern="\d{1,20}">

<hr>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
const { PDFDocument } = PDFLib;

function resizeCanvas(canvas, signaturePad) {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);

  // Guardamos la firma actual
  const data = signaturePad.toData();

  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext("2d").scale(ratio, ratio);

  // Restauramos la firma si existía
  signaturePad.clear();
  if (data) {
    signaturePad.fromData(data);
  }
}



// ====== FIRMAS ======
const canvasAlumno = document.getElementById("firma_alumno");
const canvasTitular = document.getElementById("firma_titular");

const signatureAlumno = new SignaturePad(canvasAlumno, {
  minWidth: 0.8,
  maxWidth: 2,
  penColor: "#000000"
});

const signatureTitular = new SignaturePad(canvasTitular, {
  minWidth: 0.8,
  maxWidth: 2,
  penColor: "#000000"
});
window.addEventListener("load", function() {
  resizeCanvas(canvasAlumno, signatureAlumno);
  resizeCanvas(canvasTitular, signatureTitular);
});

let resizeTimeout;

window.addEventListener("resize", function() {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    resizeCanvas(canvasAlumno, signatureAlumno);
    resizeCanvas(canvasTitular, signatureTitular);
  }, 300);
});


function soloNumeros(input) {
  input.value = input.value.replace(/\D/g, '');
}

document.getElementById("numero_tarjeta")
  .addEventListener("input", function() {
    soloNumeros(this);
  });

document.getElementById("cuit")
  .addEventListener("input", function() {
    soloNumeros(this);
  });

document.getElementById("documento_alum")
  .addEventListener("input", function() {
    soloNumeros(this);
  });

document.getElementById("documento_tit")
  .addEventListener("input", function() {
    soloNumeros(this);
  });

// ====== HABILITAR CAMPOS SEGÚN PERSONA ======

function actualizarPersona() {
  const tipo = document.getElementById("tipo_persona").value;

  const fisica = document.getElementById("fisica_section");
  const juridica = document.getElementById("juridica_section");

  fisica.classList.remove("active");
  juridica.classList.remove("active");

  if (tipo === "fisica") {
    fisica.classList.add("active");
  }

  if (tipo === "juridica") {
    juridica.classList.add("active");
  }

  actualizarProgreso();
}


  function actualizarTarjeta() {
  const tipoTarjeta = document.getElementById("tipo_tarjeta").value;
  const tarjetaSection = document.getElementById("tarjeta_section");

  tarjetaSection.classList.remove("active");

  if (tipoTarjeta !== "") {
    tarjetaSection.classList.add("active");
  }

  actualizarProgreso();
}


const camposBase = [
  "lugar",
  "fecha",
  "tipo_persona",
  "tipo_tarjeta",
  "numero_tarjeta",
  "aclaracion_alum",
  "documento_alum",
  "aclaracion_tit",
  "documento_tit"
];

function actualizarProgreso() {

  let total = 0;
  let completos = 0;

  camposBase.forEach(id => {
    const el = document.getElementById(id);

    if (id === "numero_tarjeta") {
      if (document.getElementById("tipo_tarjeta").value !== "") {
        total++;
        if (el.value.trim() !== "") completos++;
      }
    } else {
      total++;
      if (el.value.trim() !== "") completos++;
    }
  });

  // Persona dinámica
  const tipoPersona = document.getElementById("tipo_persona").value;

  if (tipoPersona === "fisica") {
    total++;
    if (document.getElementById("pers_fis_nombre").value.trim() !== "") completos++;
  }

  if (tipoPersona === "juridica") {
    total += 2;
    if (document.getElementById("pers_ju_nombre").value.trim() !== "") completos++;
    if (document.getElementById("cuit").value.trim() !== "") completos++;
  }

  // Firmas
  total += 2;
  if (!signatureAlumno.isEmpty()) completos++;
  if (!signatureTitular.isEmpty()) completos++;

  const porcentaje = Math.round((completos / total) * 100);
  document.getElementById("progressBar").style.width = porcentaje + "%";
}

function validarFormulario() {

  let valido = true;

  document.querySelectorAll("input, select").forEach(el => {
    el.classList.remove("input-error");
  });

  function marcarError(id) {
    document.getElementById(id).classList.add("input-error");
    document.getElementById(id).scrollIntoView({ behavior: "smooth", block: "center" });
    valido = false;
  }

  camposBase.forEach(id => {
    if (document.getElementById(id).value.trim() === "") {
      marcarError(id);
    }
  });

  const tipoPersona = document.getElementById("tipo_persona").value;

  if (tipoPersona === "fisica") {
    if (document.getElementById("pers_fis_nombre").value.trim() === "") {
      marcarError("pers_fis_nombre");
    }
  }

  if (tipoPersona === "juridica") {
    if (document.getElementById("pers_ju_nombre").value.trim() === "") {
      marcarError("pers_ju_nombre");
    }
    if (document.getElementById("cuit").value.trim() === "") {
      marcarError("cuit");
    }
  }

  if (signatureAlumno.isEmpty()) {
    alert("Falta la firma del alumno.");
    valido = false;
  }

  if (signatureTitular.isEmpty()) {
    alert("Falta la firma del titular.");
    valido = false;
  }

  if (!valido) {
    alert("Por favor complete todos los campos obligatorios.");
  }

  return valido;
}


// ====== GENERAR PDF ======
async function generarPDF() {

  if (!validarFormulario()) return;

  const existingPdfBytes = await fetch('Débito Automático Grado Editable.pdf')
  .then(res => res.arrayBuffer());



  const pdfDoc = await PDFDocument.load(existingPdfBytes);
  const form = pdfDoc.getForm();

  // Lugar
  form.getTextField('Lugar')
      .setText(document.getElementById('lugar').value);

  // Fecha formateada
  const fechaInput = document.getElementById('fecha').value;
  if (fechaInput) {
    const fechaObj = new Date(fechaInput);
    const fechaFormateada =
      ("0" + fechaObj.getDate()).slice(-2) + "/" +
      ("0" + (fechaObj.getMonth() + 1)).slice(-2) + "/" +
      fechaObj.getFullYear();

    form.getTextField('Fecha').setText(fechaFormateada);
  }




  // ====== PERSONA ======
  const tipoPersona = document.getElementById("tipo_persona").value;

  if (tipoPersona === "fisica") {
    form.getTextField('Pers_Fis')
        .setText(document.getElementById('pers_fis_nombre').value);

    form.getCheckBox('Check Box5').check();
  }

  if (tipoPersona === "juridica") {
    form.getTextField('Pers_Ju')
        .setText(document.getElementById('pers_ju_nombre').value);

    form.getTextField('CUIT')
        .setText(document.getElementById('cuit').value);

    form.getCheckBox('Check Box6').check();
  }

  // ====== TARJETA ======


  const tipoTarjeta = document.getElementById('tipo_tarjeta').value;
  const numeroTarjeta = document.getElementById('numero_tarjeta').value;

  if (tipoTarjeta === "Visa")
    form.getTextField('Visa').setText(numeroTarjeta);

  if (tipoTarjeta === "Master")
    form.getTextField('Master').setText(numeroTarjeta);

  if (tipoTarjeta === "American")
    form.getTextField('American').setText(numeroTarjeta);

  // ====== ALUMNO ======
  form.getTextField('Aclaracion_Alum')
      .setText(document.getElementById('aclaracion_alum').value);

  form.getTextField('Documento_Alum')
      .setText(document.getElementById('documento_alum').value);

  // ====== TITULAR ======
  form.getTextField('Aclaracion_Tit')
      .setText(document.getElementById('aclaracion_tit').value);

  form.getTextField('Documento_Tit')
      .setText(document.getElementById('documento_tit').value);

  const page = pdfDoc.getPages()[0];

 // ====== FIRMA ALUMNO ======
if (!signatureAlumno.isEmpty()) {

  const firmaPNG = canvasAlumno.toDataURL('image/png');
  const firmaBytes = await fetch(firmaPNG).then(res => res.arrayBuffer());
  const firmaImage = await pdfDoc.embedPng(firmaBytes);

  page.drawImage(firmaImage, {
    x: 80,      // un poco más a la izquierda
    y: 230,     // SUBIDA
    width: 180,
    height: 55,
  });
}

// ====== FIRMA TITULAR ======
if (!signatureTitular.isEmpty()) {

  const firmaPNG2 = canvasTitular.toDataURL('image/png');
  const firmaBytes2 = await fetch(firmaPNG2).then(res => res.arrayBuffer());
  const firmaImage2 = await pdfDoc.embedPng(firmaBytes2);

  page.drawImage(firmaImage2, {
    x: 330,     // bloque derecho
    y: 230,     // misma altura
    width: 180,
    height: 55,
  });
}


  const pdfBytes = await pdfDoc.save();

  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  // Tomamos el nombre del alumno
let nombreAlumno = document.getElementById("aclaracion_alum").value.trim();

// Si está vacío, fallback
if (!nombreAlumno) {
  nombreAlumno = "Sin_Nombre";
}

// Limpiamos caracteres inválidos para nombre de archivo
nombreAlumno = nombreAlumno
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g, "") // elimina acentos
  .replace(/[^a-zA-Z0-9\s]/g, "") // elimina símbolos raros
  .replace(/\s+/g, "_"); // espacios → guión bajo

link.download = `DA - ${nombreAlumno}.pdf`;

  link.click();
}

document.querySelectorAll("input, select").forEach(el => {
  el.addEventListener("input", actualizarProgreso);
  el.addEventListener("change", actualizarProgreso);
});

canvasAlumno.addEventListener("mouseup", actualizarProgreso);
canvasTitular.addEventListener("mouseup", actualizarProgreso);

document.addEventListener("DOMContentLoaded", function () {
  actualizarProgreso();
});

  const formData = new FormData();
formData.append("pdf", pdfBlob, nombreArchivo);

fetch("https://sandboxpdf.onrender.com/api/upload", {
  method: "POST",
  body: formData
})
.then(res => res.json())
.then(data => console.log("Subido:", data))
.catch(err => console.error("Error:", err));

  
</script>
<button onclick="generarPDF()">Generar PDF</button>


</body>
</html>
